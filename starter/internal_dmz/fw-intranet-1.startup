#This firewall aims to control intranet zone's in/out trafic
#


# eth30 to the core SW
ip addr add 192.168.1.41/24 dev eth30
ip link set up dev eth30

# eth2 to the dmz gw
ip addr add 10.0.0.17/30 dev eth2
ip link set up dev eth2

ip route add default via 192.168.1.1
ip route add 192.168.104.0/24 via 10.0.0.18

# outgress iptables rules
## ban access to vpn
iptables -A FORWARD -i eth2 -o eth30 -p all -d 172.16.0.0/21 --match conntrack --ctstate NEW -j DROP

# ingress iptables rules
## allow core sw
iptables -A INPUT -p all -s 192.168.1.0/24 -j ACCEPT
iptables -A FORWARD -i eth30 -o eth2 -p all -s 192.168.1.0/24 -j ACCEPT
## allow management zone
iptables -A INPUT -p all -s 192.168.254.0/24 -j ACCEPT
iptables -A FORWARD -i eth30 -o eth2 -p all -s 192.168.254.0/24 -j ACCEPT

## services ports
## TCP: 53, 389, 636, 80, 443
## UDP: 53, 389, 636
## allow Enterprise zone access services
## intdns
iptables -A FORWARD -i eth30 -o eth2 -p tcp -s 192.168.102.0/24 -d 192.168.104.2 --dport 53 -j ACCEPT
iptables -A FORWARD -i eth30 -o eth2 -p udp -s 192.168.102.0/24 -d 192.168.104.2 --dport 53 -j ACCEPT
## intwww
iptables -A FORWARD -i eth30 -o eth2 -p tcp -s 192.168.102.0/24 -d 192.168.104.3 --dport 80 -j ACCEPT
## ldap
iptables -A FORWARD -i eth30 -o eth2 -p tcp -s 192.168.102.0/24 -d 192.168.104.4 -m multiport --dports 389,636 -j ACCEPT

## allow Restricted zone
## intdns
iptables -A FORWARD -i eth30 -o eth2 -p tcp -s 192.168.105.0/24 -d 192.168.104.2 --dport 53 -j ACCEPT
iptables -A FORWARD -i eth30 -o eth2 -p udp -s 192.168.105.0/24 -d 192.168.104.2 --dport 53 -j ACCEPT
## intwww
iptables -A FORWARD -i eth30 -o eth2 -p tcp -s 192.168.105.0/24 -d 192.168.104.3 --dport 80 -j ACCEPT
## ldap
iptables -A FORWARD -i eth30 -o eth2 -p tcp -s 192.168.105.0/24 -d 192.168.104.4 -m multiport --dports 389,636 -j ACCEPT

## allow vpn access services
## intdns
iptables -A FORWARD -i eth30 -o eth2 -p tcp -s 172.16.0.0/21 -d 192.168.104.2 --dport 53 -j ACCEPT
iptables -A FORWARD -i eth30 -o eth2 -p udp -s 172.16.0.0/21 -d 192.168.104.2 --dport 53 -j ACCEPT
## intwww
iptables -A FORWARD -i eth30 -o eth2 -p tcp -s 172.16.0.0/21 -d 192.168.104.3 --dport 80 -j ACCEPT
## ldap
iptables -A FORWARD -i eth30 -o eth2 -p tcp -s 172.16.0.0/21 -d 192.168.104.4 -m multiport --dports 389,636 -j ACCEPT


## At last, deny all
iptables -A FORWARD -i eth30 -o eth2 -p all --match conntrack --ctstate NEW  -j REJECT
iptables -A INPUT -p all --match conntrack --ctstate NEW  -j REJECT
